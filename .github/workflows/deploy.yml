name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: true
        default: 'latest'
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    container:
      image: alpine/helm:latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to Kubernetes
      env:
        KUBECONFIG_DATA: ${{ secrets.KUBECONFIG }}
      run: |
        echo "$KUBECONFIG_DATA" | base64 -d > /tmp/kubeconfig
        export KUBECONFIG=/tmp/kubeconfig
        helm upgrade --install peah-db ./k8s \
          --namespace lolmeida \
          --set image.tag=${{ github.event.inputs.image_tag }}